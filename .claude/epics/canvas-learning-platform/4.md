---
name: chat-messaging
epic: canvas-learning-platform
status: backlog
priority: high
created: 2025-09-05T08:14:35Z
effort: 6
complexity: medium
tags: [supabase-realtime, chat, messaging, real-time]
depends_on: [001, 002, 003]
parallel: [004, 006]
github: https://github.com//issues/4
---

# Task: Chat & Messaging

## Overview

Implement real-time chat and messaging system using Supabase Realtime for instant communication between students and teachers. Features include course-specific channels, direct messaging, file sharing, message history, and push notifications with mobile-optimized chat interface.

## Context

The chat and messaging system enables real-time communication within the Canvas Learning Platform, supporting both course-wide discussions and private conversations. This builds upon the authentication and course management systems to provide context-aware messaging with file sharing capabilities and comprehensive message history.

## Acceptance Criteria

### Functional Requirements
- [ ] Real-time messaging in course channels and direct messages
- [ ] Course-specific chat channels with participant management
- [ ] Private direct messaging between users
- [ ] File sharing with drag-and-drop support (images, documents, videos)
- [ ] Message history with infinite scroll and search
- [ ] Online/offline status indicators
- [ ] Push notifications for new messages
- [ ] Message reactions and reply threading
- [ ] Typing indicators and read receipts
- [ ] Message formatting (bold, italics, links, code blocks)

### Technical Requirements
- [ ] Supabase Realtime WebSocket integration
- [ ] Real-time message synchronization across devices
- [ ] Message delivery confirmation and retry logic
- [ ] File upload handling with progress indicators
- [ ] Message caching for offline viewing
- [ ] Cross-platform notification support
- [ ] Efficient pagination for message history
- [ ] Database optimization for chat queries

### User Experience Requirements
- [ ] Instant message delivery (<200ms latency)
- [ ] Smooth scrolling with lazy loading
- [ ] Mobile-optimized chat interface
- [ ] Keyboard shortcuts for desktop users
- [ ] Emoji picker and reaction interface
- [ ] File preview in chat (images, PDFs)
- [ ] Responsive design across all screen sizes
- [ ] Accessibility: screen reader and keyboard navigation support

## Technical Approach

### Supabase Realtime Architecture

#### Database Schema
```sql
-- Chat channels (course-wide or direct messages)
CREATE TABLE chat_channels (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    name VARCHAR(255),
    type channel_type NOT NULL, -- 'course', 'direct', 'group'
    course_id UUID REFERENCES courses(id), -- NULL for direct messages
    created_by UUID REFERENCES profiles(id),
    created_at TIMESTAMPTZ DEFAULT now(),
    updated_at TIMESTAMPTZ DEFAULT now(),
    is_archived BOOLEAN DEFAULT false
);

-- Channel memberships
CREATE TABLE channel_members (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    channel_id UUID REFERENCES chat_channels(id) ON DELETE CASCADE,
    user_id UUID REFERENCES profiles(id) ON DELETE CASCADE,
    role member_role DEFAULT 'member', -- 'admin', 'moderator', 'member'
    joined_at TIMESTAMPTZ DEFAULT now(),
    last_read_at TIMESTAMPTZ DEFAULT now(),
    is_muted BOOLEAN DEFAULT false,
    UNIQUE(channel_id, user_id)
);

-- Messages
CREATE TABLE messages (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    channel_id UUID REFERENCES chat_channels(id) ON DELETE CASCADE,
    sender_id UUID REFERENCES profiles(id),
    content TEXT,
    message_type message_type DEFAULT 'text', -- 'text', 'file', 'image', 'system'
    reply_to_id UUID REFERENCES messages(id),
    edited_at TIMESTAMPTZ,
    created_at TIMESTAMPTZ DEFAULT now(),
    metadata JSONB -- file info, reactions, etc.
);

-- Message reactions
CREATE TABLE message_reactions (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    message_id UUID REFERENCES messages(id) ON DELETE CASCADE,
    user_id UUID REFERENCES profiles(id) ON DELETE CASCADE,
    emoji VARCHAR(10) NOT NULL,
    created_at TIMESTAMPTZ DEFAULT now(),
    UNIQUE(message_id, user_id, emoji)
);

-- File attachments
CREATE TABLE message_files (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    message_id UUID REFERENCES messages(id) ON DELETE CASCADE,
    file_name VARCHAR(255) NOT NULL,
    file_size BIGINT,
    file_type VARCHAR(100),
    storage_path TEXT NOT NULL,
    created_at TIMESTAMPTZ DEFAULT now()
);
```

#### Row Level Security Policies
```sql
-- Users can only access channels they're members of
CREATE POLICY "Users can view their channels" ON chat_channels
    FOR SELECT USING (
        id IN (
            SELECT channel_id FROM channel_members 
            WHERE user_id = auth.uid()
        )
    );

-- Users can only see messages in their channels
CREATE POLICY "Users can view channel messages" ON messages
    FOR SELECT USING (
        channel_id IN (
            SELECT channel_id FROM channel_members 
            WHERE user_id = auth.uid()
        )
    );
```

### Implementation Components

#### 1. Chat Service
```dart
class ChatService {
  final SupabaseClient _supabase;
  final RealtimeChannel? _channel;
  
  Stream<List<Message>> subscribeToChannel(String channelId) {
    return _supabase
        .from('messages')
        .stream(primaryKey: ['id'])
        .eq('channel_id', channelId)
        .order('created_at', ascending: true);
  }
  
  Future<void> sendMessage(String channelId, String content, 
                          {String? replyToId, List<File>? files}) async {
    // Message sending with file upload
  }
  
  Future<void> markAsRead(String channelId) async {
    // Update last_read_at timestamp
  }
}
```

#### 2. Real-time Message Widget
```dart
class ChatWidget extends StatefulWidget {
  final String channelId;
  final ChannelType channelType;
  
  @override
  Widget build(BuildContext context) {
    return Column(
      children: [
        Expanded(child: MessagesList()),
        MessageInput(),
      ],
    );
  }
}

class MessagesList extends StatelessWidget {
  @override
  Widget build(BuildContext context) {
    return StreamBuilder<List<Message>>(
      stream: context.read<ChatService>()
          .subscribeToChannel(widget.channelId),
      builder: (context, snapshot) {
        return ListView.builder(
          reverse: true,
          itemCount: messages.length,
          itemBuilder: (context, index) {
            return MessageBubble(message: messages[index]);
          },
        );
      },
    );
  }
}
```

#### 3. File Sharing Component
```dart
class FileUploadService {
  Future<String> uploadFile(File file, String channelId) async {
    final path = 'chat-files/$channelId/${uuid.v4()}';
    await _supabase.storage
        .from('chat-files')
        .upload(path, file);
    return path;
  }
  
  String getPublicUrl(String path) {
    return _supabase.storage
        .from('chat-files')
        .getPublicUrl(path);
  }
}
```

### Real-time Features Implementation

#### Typing Indicators
```dart
class TypingService {
  Timer? _typingTimer;
  
  void sendTypingIndicator(String channelId) {
    _supabase.channel('typing:$channelId')
        .send(type: 'broadcast', event: 'typing', payload: {
          'user_id': _supabase.auth.currentUser?.id,
          'is_typing': true,
        });
    
    // Auto-stop after 3 seconds
    _typingTimer?.cancel();
    _typingTimer = Timer(Duration(seconds: 3), () => stopTyping(channelId));
  }
}
```

#### Online Presence
```dart
class PresenceService {
  void trackUserPresence(String channelId) {
    final presence = _supabase.channel('presence:$channelId');
    
    presence.on(RealtimeListenTypes.presence, ChannelFilter(event: 'sync'), 
        (payload, [ref]) {
      // Handle online users list updates
    });
    
    presence.subscribe((status) {
      if (status == 'SUBSCRIBED') {
        presence.track({'online_at': DateTime.now().toIso8601String()});
      }
    });
  }
}
```

## UI/UX Design Requirements

### Chat Interface Layout

#### Desktop Layout
- **Sidebar**: Channel list with unread indicators
- **Main Area**: Message history with infinite scroll
- **Input Area**: Message composer with file upload and formatting
- **Right Panel**: Member list and channel info (collapsible)

#### Mobile Layout
- **Channel List**: Swipeable drawer or bottom sheet
- **Chat View**: Full-screen message interface
- **Input**: Sticky bottom input with attachment button
- **File Sharing**: Native mobile file picker integration

### Message Bubble Design
```dart
class MessageBubble extends StatelessWidget {
  final Message message;
  
  @override
  Widget build(BuildContext context) {
    return Container(
      margin: EdgeInsets.symmetric(vertical: 2, horizontal: 8),
      child: Row(
        crossAxisAlignment: CrossAxisAlignment.start,
        children: [
          UserAvatar(userId: message.senderId),
          SizedBox(width: 8),
          Expanded(
            child: Column(
              crossAxisAlignment: CrossAxisAlignment.start,
              children: [
                MessageHeader(),
                MessageContent(),
                if (message.files?.isNotEmpty == true) FileAttachments(),
                MessageReactions(),
              ],
            ),
          ),
        ],
      ),
    );
  }
}
```

### Responsive Design Features
- Adaptive grid for file previews
- Dynamic text sizing based on screen size
- Touch-friendly controls on mobile
- Keyboard shortcuts on desktop
- Swipe gestures for mobile navigation

## Testing Strategy

### Unit Tests
- [ ] Message sending and receiving logic
- [ ] File upload service functionality
- [ ] Real-time subscription management
- [ ] Message formatting and parsing
- [ ] Notification scheduling

### Widget Tests
- [ ] Chat widget rendering and interactions
- [ ] Message bubble layouts and styling
- [ ] File attachment display components
- [ ] Emoji picker and reaction interface
- [ ] Typing indicators and presence UI

### Integration Tests
- [ ] Real-time message synchronization
- [ ] Cross-device message delivery
- [ ] File sharing end-to-end workflow
- [ ] Push notification delivery
- [ ] Offline message caching and sync

### Performance Tests
- [ ] Message loading performance (1000+ messages)
- [ ] Real-time latency measurements
- [ ] File upload progress and completion
- [ ] Memory usage with large chat history
- [ ] Battery impact on mobile devices

## Security Considerations

### Message Security
- Row-level security for channel access
- Content sanitization for XSS prevention
- File upload validation and scanning
- Message encryption for sensitive content
- Rate limiting for message frequency

### File Sharing Security
- File type validation and restrictions
- Virus scanning for uploaded files
- Storage quota enforcement per user
- Secure file URL generation with expiration
- Access control for private channel files

### Privacy Controls
- Message deletion and edit capabilities
- Channel leave/archive functionality
- User blocking and reporting features
- GDPR-compliant data deletion
- Message history export options

## Deployment & Configuration

### Environment Variables
```bash
SUPABASE_REALTIME_URL=wss://your-project.supabase.co/realtime/v1
SUPABASE_ANON_KEY=your_anon_key
CHAT_FILE_BUCKET=chat-files
MAX_FILE_SIZE=50MB
ALLOWED_FILE_TYPES=jpg,png,pdf,doc,docx,mp4
```

### Database Optimizations
```sql
-- Indexes for chat performance
CREATE INDEX idx_messages_channel_created_at 
    ON messages(channel_id, created_at DESC);
CREATE INDEX idx_channel_members_user_id 
    ON channel_members(user_id);
CREATE INDEX idx_messages_sender_id 
    ON messages(sender_id);
```

### Real-time Configuration
```dart
final client = SupabaseClient(
  supabaseUrl,
  supabaseAnonKey,
  realtimeClientOptions: RealtimeClientOptions(
    heartbeatIntervalMs: 30000,
    logLevel: RealtimeLogLevel.info,
  ),
);
```

## Push Notifications

### Flutter Local Notifications Setup
```dart
class NotificationService {
  Future<void> setupNotifications() async {
    // Configure local notifications
    await flutterLocalNotificationsPlugin.initialize(
      const InitializationSettings(
        android: AndroidInitializationSettings('@mipmap/ic_launcher'),
        iOS: DarwinInitializationSettings(),
      ),
    );
  }
  
  Future<void> showMessageNotification(Message message) async {
    // Display chat notification
  }
}
```

### Background Message Handling
```dart
class BackgroundMessageHandler {
  static void handleBackgroundMessage(Map<String, dynamic> message) {
    // Process messages when app is in background
    NotificationService.showMessageNotification(message);
  }
}
```

## Monitoring & Analytics

### Key Metrics
- Message delivery success rate
- Real-time connection stability
- Average message response time
- File sharing usage statistics
- User engagement in channels
- Mobile vs desktop usage patterns

### Error Tracking
- WebSocket connection failures
- Message delivery failures
- File upload errors and retries
- Notification delivery issues
- Performance bottlenecks

## Documentation Requirements

### Developer Documentation
- Supabase Realtime integration guide
- Chat component API documentation
- File sharing implementation details
- Push notification setup guide

### User Documentation
- Chat and messaging user guide
- File sharing instructions
- Mobile app messaging features
- Privacy and security settings

## Dependencies

### External Dependencies
- Supabase Realtime service
- Firebase Cloud Messaging (notifications)
- Flutter Local Notifications plugin
- File picker and camera plugins

### Internal Dependencies
- Authentication system (Task 001)
- Database foundation (Task 002)
- Course management system (Task 003)
- User profile management

### Flutter Package Dependencies
- supabase_flutter: ^2.0.0
- flutter_local_notifications: ^17.0.0
- file_picker: ^8.0.0
- image_picker: ^1.0.0
- cached_network_image: ^3.3.0
- emoji_picker_flutter: ^2.0.0

## Risk Assessment

### Technical Risks
- **Medium**: Real-time connection stability
- **Low**: Message delivery reliability
- **Low**: File upload performance

### Mitigation Strategies
- Connection retry logic with exponential backoff
- Message queue for offline scenarios
- File compression and progress indicators
- Performance monitoring and optimization

## Estimated Timeline

### Development: 6 days
- **Days 1-2**: Supabase Realtime setup and basic messaging
- **Days 3-4**: File sharing and message formatting
- **Days 5-6**: Mobile optimization and push notifications

### Testing: 1.5 days
- Real-time functionality testing
- Cross-platform compatibility
- Performance validation
- Security testing

### Total Effort: 6 points (1.5 weeks)